<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Dublin Bikes App</title>

    <link href="../style.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
	<script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
	<script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.0/jquery.min.js"></script>
    <meta name="viewport" content="initial-scale=1.0,user-scalable=no">

    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js"></script>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">

    <script type="text/javascript"
        src="https://www.gstatic.com/charts/loader.js"></script>
    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD_GFOa8RKF4FM4SkpVD6LJdz0fI86pIac&callback=initMap"
            type="text/javascript">
    </script>

</head>

<body>

    <div id="headBg" style="margin-bottom:0">
            <h1>Dublin Bikes</h1>
            <p>Find your best station!</p>
          </div>

    <nav class="navbar navbar-inverse">
          <div class="container-fluid">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="#">Dublin Bikes.</a>
            </div>
            <div class="collapse navbar-collapse" id="myNavbar">
              <ul class="nav navbar-nav">
                <li class="active"><a href="#">Home</a></li>
                <li><a href="#">Details</a></li>
              </ul>
            </div>
          </div>
        </nav>

    <div id="map"></div>

    <div id="sidebar">

        <h3> The current weather is: </h3>
            <p id="currentTemp"></p>
            <p id="currentWeather"></p>
            <p id="windSpeed"></p>
            <div id="icon"></div>
            <div id="display" class="polaroid">
                <div id="occupancy"></div>
            </div>
            <div class="stats" id ="daily_div"></div>
            <div class="stats" id="hourly_div"></div>
    </div>


<script type="text/javascript">


    function initMap() {
        // ROOT is the location of our flask app
        ROOT = window.location.origin;
        // radius units are metres
        radius = 23, zoom = 14;
        var centre = {
            lat: 53.346763,
            lng: -6.2568436
        };
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: zoom,
            center: centre
        });
        var infoWindow = new google.maps.InfoWindow();
        $.getJSON('http://127.0.0.1:5000/stations', null, function (data) {
            var stations = data.stations;
            console.log(stations)
            $.each(stations, function (i,station) {
                // console.log(station.name, station.number);
                var marker = new google.maps.Marker({
                    position: {
                        lat: station.position_lat,
                        lng: station.position_lng
                    },
                    map: map,
                    title: station.name,
                    number: station.number
                });
                marker.metadata = {type: "point", id: station.number};
                google.maps.event.addListener(marker, 'click', (function(marker, stations) {
                    return function() {
                        if (station.banking == 1) {
                            station.banking = "Yes";
                        } else {
                            station.banking = "No";
                        }
						var number = station.number;
                    	var content = "Station name: " + station.name + "<br><br>" + "Banking: " + station.banking + "<br><br>";
                        var button = "<button onclick='getOccupancy(" + number + ")'>Show More Information</button>";
                        infoWindow.setContent(content + "<br> " + button);
                        infoWindow.open(map, marker);
                    }
                })(marker, stations));
            });
        });
    }

    getWeather();

    function getWeather(){
    //call weather API from openweathermap
        var weatherdata;
        $.getJSON('http://api.openweathermap.org/data/2.5/weather?q=Dublin,ie&units=metric&appid=5508cb29a72478e8bc8021bbe590ee4e',function(data){
        var weather = data.weather[0].description;
        var temp=data.main.temp;
        var windSpeed=data.wind.speed;
        var icon = data.weather[0].icon;
        var iconUrl = ("<img src='http://openweathermap.org/img/w/" + icon + ".png'>");

        $("#currentWeather").html(weather);
        $("#currentTemp").html(temp + " Degrees Centigrade");
        $("#windSpeed").html(windSpeed + " m/s");
        $("#icon").html(iconUrl);

        })
    }


    google.charts.load("visualization", "1", {packages:["corechart"]});


    function getOccupancy(number) {
        document.getElementById("occupancy").style.display = "inline-block";
        $.getJSON("http://127.0.0.1:5000/occupancy/" + number, null, function (data) {
            var occupancy = data.occupancy;
            _.forEach(occupancy, function (station) {
                var content = "<b><u>Currently there are: </u></b><br><br> Bikes available: " + station.available_bikes + "<br>" + "Bike stands available: " + station.available_bike_stands + "<br></div>";
                document.getElementById("occupancy").innerHTML = content;
            })
        });

        $.getJSON("http://127.0.0.1:5000/daily/" + number, null, function (data) {
            google.charts.setOnLoadCallback(drawChart(data));
        });

        function drawChart(data) {
            var data_array_bikes = data.week_average_bikes;
            var data_array_stands = data.week_average_stands;
            var data_daily = new google.visualization.DataTable(data_array_bikes);

            data_daily.addColumn('string', 'Day');
            data_daily.addColumn('number', 'Bikes');
            data_daily.addColumn('number', 'Stands');

            data_daily.addRows([
                ['Monday', data_array_bikes[0], data_array_stands[0]],
                ['Tuesday', data_array_bikes[1], data_array_stands[1]],
                ['Wednesday', data_array_bikes[2], data_array_stands[2]],
                ['Thursday', data_array_bikes[3], data_array_stands[3]],
                ['Friday', data_array_bikes[4], data_array_stands[4]],
                ['Saturday', data_array_bikes[5], data_array_stands[5]],
                ['Sunday', data_array_bikes[6], data_array_stands[6]]
            ]);

            //Set chart options
            var options = {'title': 'Daily Averages:', 'width': 500, 'height': 400};

            //instantiate and draw our chart, passing in some options
            var chart = new google.visualization.BarChart(document.getElementById('daily_div'));
            chart.draw(data_daily, options);
        }
    }
</script>


</body>
</html>
